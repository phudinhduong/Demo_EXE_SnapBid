/*
  UART log CSV + LCD + DS1307 + LM35 

  LCD 16x2:
    VSS->GND, VDD->5V, V0->biến trở 10k (2 đầu: 5V & GND)
    RS->D7, 
    RW->GND, 
    E->D8, D4->D9, D5->D10, D6->D11, D7->D12
    A(LED+)->5V, K(LED-)->GND

  DS1307:
    VCC->5V, GND->GND, SDA->A4, SCL->A5

  LM35:
    V+->5V, Vout->A0, GND->GND 
*/

#include <Wire.h>
#include "RTClib.h"
#include <LiquidCrystal.h>

LiquidCrystal lcd(7, 8, 9, 10, 11, 12);
RTC_DS1307 rtc;
const char* DOW[7] = {"Sun","Mon","Tue","Wed","Thu","Fri","Sat"};

const int PIN_LM35 = A0;
const float TEMP_LOW  = 20.0;   // < 20°C: COLD
const float TEMP_HIGH = 30.0;   // > 30°C: HOT
const float HYST      = 0.5;

enum AlertState { NORMAL, COLD, HOT };
AlertState alertState = NORMAL;

#if defined(__AVR_ATmega2560__) || defined(__AVR_ATmega1280__)
  #define ANALOG_REF_CALL analogReference(INTERNAL1V1)
  #define VREF_VOLTS 1.1
#elif defined(__AVR_ATmega328P__)
  #define ANALOG_REF_CALL analogReference(INTERNAL)
  #define VREF_VOLTS 1.1
#else
  #define ANALOG_REF_CALL /* no-op */
  #define VREF_VOLTS 5.0
#endif

// ---- helpers ----
void clearLine(uint8_t row){ lcd.setCursor(0,row); lcd.print("                "); }
void print2d(Print &out, uint8_t v){ if(v<10) out.print('0'); out.print(v); }

float readLM35C(){
  long sum=0; for(int i=0;i<10;i++){ sum+=analogRead(PIN_LM35); delay(2); }
  float adc = sum/10.0;
  float voltage = adc * (VREF_VOLTS/1023.0);
  return voltage * 100.0; // 10mV/°C
}

void updateAlert(float t){
  switch(alertState){
    case NORMAL: if(t<TEMP_LOW) alertState=COLD; else if(t>TEMP_HIGH) alertState=HOT; break;
    case COLD:   if(t>TEMP_LOW+HYST)  alertState=NORMAL; break;
    case HOT:    if(t<TEMP_HIGH-HYST) alertState=NORMAL; break;
  }
}

const char* alertLabel(){
  switch(alertState){ case COLD: return "COLD"; case HOT: return "HOT"; default: return "NORMAL"; }
}

void setup(){
  // LCD
  lcd.begin(16,2);
  lcd.setCursor(0,0); lcd.print("RTC+LM35+LCD+UART");
  lcd.setCursor(0,1); lcd.print("Starting...");

  // ADC reference
  ANALOG_REF_CALL; delay(5);

  // RTC
  if(!rtc.begin()){ clearLine(0); lcd.print("ERR: RTC notfound"); while(1); }
  if(!rtc.isrunning()){ rtc.adjust(DateTime(F(__DATE__), F(__TIME__))); }

  // UART
  Serial.begin(9600);
  // Header CSV (một lần)
  Serial.println(F("date,time,tempC,alert"));

  delay(600);
  lcd.clear();
}

void loop(){
  static unsigned long lastLCD=0, lastLog=0;
  unsigned long ms = millis();

  DateTime now = rtc.now();
  float tC = readLM35C();
  updateAlert(tC);

  // --- LCD: cập nhật ~2 lần/giây ---
  if(ms - lastLCD >= 500){
    lastLCD += 500;

    char line1[17];
    snprintf(line1, sizeof(line1), "%02d/%02d/%04d %s",
             now.day(), now.month(), now.year(), DOW[now.dayOfTheWeek()]);
    clearLine(0); lcd.setCursor(0,0); lcd.print(line1);

    // dòng 2: HH:MM:SS  XX.X°C  (khi cảnh báo sẽ luân phiên nội dung)
    static bool showAlt=false; static unsigned long lastToggle=0;
    if(alertState!=NORMAL && ms-lastToggle>=1000){ lastToggle=ms; showAlt=!showAlt; }
    if(alertState==NORMAL){ showAlt=false; }

    clearLine(1); lcd.setCursor(0,1);
    if(!showAlt){
      print2d(lcd, now.hour()); lcd.print(':');
      print2d(lcd, now.minute()); lcd.print(':');
      print2d(lcd, now.second()); lcd.print(' ');
      lcd.print(tC,1); lcd.print((char)223); lcd.print('C');
    }else{
      if(alertState==COLD){ lcd.print("LANH! MAC AO  "); }
      else if(alertState==HOT){ lcd.print("NONG! BAT QUAT"); }
    }
  }

  // --- UART log CSV: mỗi 1 giây ---
  if(ms - lastLog >= 1000){
    lastLog += 1000;
    // date
    Serial.print(now.year()); Serial.print('-');
    print2d(Serial, now.month()); Serial.print('-');
    print2d(Serial, now.day());   Serial.print(',');
    // time
    print2d(Serial, now.hour());  Serial.print(':');
    print2d(Serial, now.minute());Serial.print(':');
    print2d(Serial, now.second());Serial.print(',');
    // temp + alert
    Serial.print(tC,1); Serial.print(',');
    Serial.println(alertLabel());
  }
}
